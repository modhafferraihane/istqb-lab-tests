# .github/workflows/tests.yml
# ============================================================
# LAB 03 - Workflow GitHub Actions pour tests automatisés
# ISTQB Foundation Level - Intégration Continue
# ============================================================

name: Tests ISTQB Lab

# ============================================================
# DÉCLENCHEURS
# Le workflow s'exécute automatiquement lors de :
# - Push sur les branches main ou master
# - Pull request vers main ou master
# ============================================================
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# ============================================================
# JOBS
# Définition des tâches à exécuter
# ============================================================
jobs:
  test:
    name: Exécution des tests
    
    # Environnement : Machine virtuelle Ubuntu
    runs-on: ubuntu-latest
    
    steps:
      # --------------------------------------------------------
      # Étape 1 : Récupérer le code source
      # --------------------------------------------------------
      - name: Checkout du code
        uses: actions/checkout@v4

      # --------------------------------------------------------
      # Étape 2 : Installer Node.js
      # --------------------------------------------------------
      - name: Installation de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # --------------------------------------------------------
      # Étape 3 : Installer les dépendances npm
      # --------------------------------------------------------
      - name: Installation des dépendances
        run: npm install

      # --------------------------------------------------------
      # Étape 4 : Installer les navigateurs Playwright
      # --------------------------------------------------------
      - name: Installation des navigateurs
        run: npx playwright install --with-deps

      # --------------------------------------------------------
      # Étape 5 : Exécuter les tests
      # --------------------------------------------------------
      - name: Exécution des tests
        run: npx playwright test

      # --------------------------------------------------------
      # Étape 6 : Message de succès
      # --------------------------------------------------------
      - name: Tests réussis
        if: success()
        run: |
          echo "=========================================="
          echo "       TOUS LES TESTS ONT REUSSI !       "
          echo "=========================================="
          echo ""
          echo "Bravo ! Votre code est valide."
          echo "Les tests automatises sont passes avec succes."

      # --------------------------------------------------------
      # Étape 7 : Sauvegarder le rapport HTML (en cas d'échec)
      # --------------------------------------------------------
      - name: Sauvegarde du rapport
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
